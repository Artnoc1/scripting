# Copyright (c) TOGGL LLC
# All rights reserved.
# Published under New BSD license

# This file provides:

# init_d_refresh - start init.d script if not started, else force-reload
# package_installed - apt-get install only if not installed
# run_file_as_user - runs executable as other user, fixing file permissions
# save_heredoc_in - puts heredoc into file and adds file to tracking list
# track_path - adds file to tracking list

set -o pipefail # trace ERR through pipes
set -o errtrace # trace ERR through functions
set -o nounset  # fail if used unuset variable
set -o errexit  # abort on first unsucessfull line

# This file contains helpers for role manager.
# following two variables must be set before including fhis file:
[[ -z "${TOGGL_ROLE_NAME}" ]] && (echo 'Must set TOGGL_ROLE_NAME before sourcing'; exit 99)
[[ -z "${TOGGL_ROLE_VERSION}" ]] && (echo 'Must set TOGGL_ROLE_VERSION before sourcing'; exit 99)

### Config
TOGGL_ROLE_CONFIG_PATH=${TOGGL_ROLE_CONFIG_PATH:-'/opt/toggl/scripting/etc'}
TOGGL_ROLE_NOTIFIER=${TOGGL_ROLE_NOTIFIER:-'/usr/bin/team_notify'}

TOGGL_ROLES_PATH=${TOGGL_ROLES_PATH:-"${TOGGL_ROLE_CONFIG_PATH}/roles"}
TOGGL_ROLE_FILES_PATH=${TOGGL_ROLE_FILES_PATH:-"${TOGGL_ROLE_CONFIG_PATH}/files"}

TOGGL_ROLE_VERSION_FILE="${TOGGL_ROLES_PATH}/${TOGGL_ROLE_NAME}"
TOGGL_ROLE_FILE_LIST="${TOGGL_ROLE_FILES_PATH}/${TOGGL_ROLE_NAME}"

### Housekeeping
mkdir -vp "${TOGGL_ROLES_PATH}"
mkdir -vp "${TOGGL_ROLE_FILES_PATH}"

# Empty tracklist from previous runs
[ -f "${TOGGL_ROLE_FILE_LIST}" ] && rm -v "${TOGGL_ROLE_FILE_LIST}"
# Assume we don't finish
echo "Failed install" > "${TOGGL_ROLE_VERSION_FILE}"

###  public api, every proc has arguments re-mapped to local's

init_d_refresh() {
  local script_name=${1}

  (/etc/init.d/${script_name} status && /etc/init.d/${script_name} force-reload) || true
  /etc/init.d/${script_name} status || /etc/init.d/${script_name} start
}

package_installed() {
  # package names as arguments

  for package_name in "$@"
  do
    dpkg --status ${package_name} >/dev/null || apt-get install ${package_name}
  done
}

run_file_as_user(){
  local file_to_run=${1}
  local target_user=${2}

  local current_path=$(pwd)
  cd $(dirname ${file_to_run})

  chmod a+x ${file_to_run}
  chown ${target_user} ${file_to_run}
  sudo -iu ${target_user} ${file_to_run}

  rm -rvf ${file_to_run}
  cd ${current_path}
}

save_heredoc_in(){
  local target_file=${1}

  track_path "${target_file}"
  cat - > "${target_file}"
}

track_path(){
  local path_to_add=${1}

  echo "${path_to_add}" >> "${TOGGL_ROLE_FILE_LIST}"
}

### private stuff, do not call directly.

__finalize(){
  local previous_status=${?}

  if [ ${previous_status} -eq 0 ]; then
    echo "${TOGGL_ROLE_VERSION}" > "${TOGGL_ROLE_VERSION_FILE}"

    [ -f "${TOGGL_ROLE_FILE_LIST}" ] && sort --unique --output="${TOGGL_ROLE_FILE_LIST}" "${TOGGL_ROLE_FILE_LIST}"
    [ -f ${TOGGL_ROLE_NOTIFIER} ] && ${TOGGL_ROLE_NOTIFIER} "Added ${TOGGL_ROLE_NAME}-${TOGGL_ROLE_VERSION}"
    exit 0
  else
    [ -f "${TOGGL_ROLE_NOTIFIER}" ] && ${TOGGL_ROLE_NOTIFIER} "Failed to add ${TOGGL_ROLE_NAME}-${TOGGL_ROLE_VERSION}"
    exit ${previous_status}
  fi
}

trap __finalize EXIT